/**
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function ClusterIcon(b,a){b.getMarkerClusterer().extend(ClusterIcon,google.maps.OverlayView);this.cluster_=b;this.className_=b.getMarkerClusterer().getClusterClass();this.styles_=a;this.center_=null;this.div_=null;this.sums_=null;this.visible_=false;this.setMap(b.getMap())}ClusterIcon.prototype.onAdd=function(){var b=this;var a;var c;this.div_=document.createElement("div");this.div_.className=this.className_;if(this.visible_){this.show()}this.getPanes().overlayMouseTarget.appendChild(this.div_);this.boundsChangedListener_=google.maps.event.addListener(this.getMap(),"bounds_changed",function(){c=a});google.maps.event.addDomListener(this.div_,"mousedown",function(){a=true;c=false});google.maps.event.addDomListener(this.div_,"click",function(g){a=false;if(!c){var f;var d;var h=b.cluster_.getMarkerClusterer();google.maps.event.trigger(h,"click",b.cluster_);google.maps.event.trigger(h,"clusterclick",b.cluster_);if(h.getZoomOnClick()){d=h.getMaxZoom();f=b.cluster_.getBounds();h.getMap().fitBounds(f);setTimeout(function(){h.getMap().fitBounds(f);if(d!==null&&(h.getMap().getZoom()>d)){h.getMap().setZoom(d+1)}},100)}g.cancelBubble=true;if(g.stopPropagation){g.stopPropagation()}}});google.maps.event.addDomListener(this.div_,"mouseover",function(){var d=b.cluster_.getMarkerClusterer();google.maps.event.trigger(d,"mouseover",b.cluster_)});google.maps.event.addDomListener(this.div_,"mouseout",function(){var d=b.cluster_.getMarkerClusterer();google.maps.event.trigger(d,"mouseout",b.cluster_)})};ClusterIcon.prototype.onRemove=function(){if(this.div_&&this.div_.parentNode){this.hide();google.maps.event.removeListener(this.boundsChangedListener_);google.maps.event.clearInstanceListeners(this.div_);this.div_.parentNode.removeChild(this.div_);this.div_=null}};ClusterIcon.prototype.draw=function(){if(this.visible_){var a=this.getPosFromLatLng_(this.center_);this.div_.style.top=a.y+"px";this.div_.style.left=a.x+"px"}};ClusterIcon.prototype.hide=function(){if(this.div_){this.div_.style.display="none"}this.visible_=false};ClusterIcon.prototype.show=function(){if(this.div_){var b="";var d=this.backgroundPosition_.split(" ");var a=parseInt(d[0].replace(/^\s+|\s+$/g,""),10);var c=parseInt(d[1].replace(/^\s+|\s+$/g,""),10);var e=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(e);b="<img src='"+this.url_+"' style='position: absolute; top: "+c+"px; left: "+a+"px; ";if(!this.cluster_.getMarkerClusterer().enableRetinaIcons_){b+="clip: rect("+(-1*c)+"px, "+((-1*a)+this.width_)+"px, "+((-1*c)+this.height_)+"px, "+(-1*a)+"px);"}b+="'>";this.div_.innerHTML=b+"<div style='position: absolute;top: "+this.anchorText_[0]+"px;left: "+this.anchorText_[1]+"px;color: "+this.textColor_+";font-size: "+this.textSize_+"px;font-family: "+this.fontFamily_+";font-weight: "+this.fontWeight_+";font-style: "+this.fontStyle_+";text-decoration: "+this.textDecoration_+";text-align: center;width: "+this.width_+"px;line-height:"+this.height_+"px;'>"+this.sums_.text+"</div>";if(typeof this.sums_.title==="undefined"||this.sums_.title===""){this.div_.title=this.cluster_.getMarkerClusterer().getTitle()}else{this.div_.title=this.sums_.title}this.div_.style.display=""}this.visible_=true};ClusterIcon.prototype.useStyle=function(c){this.sums_=c;var a=Math.max(0,c.index-1);a=Math.min(this.styles_.length-1,a);var b=this.styles_[a];this.url_=b.url;this.height_=b.height;this.width_=b.width;this.anchorText_=b.anchorText||[0,0];this.anchorIcon_=b.anchorIcon||[parseInt(this.height_/2,10),parseInt(this.width_/2,10)];this.textColor_=b.textColor||"black";this.textSize_=b.textSize||11;this.textDecoration_=b.textDecoration||"none";this.fontWeight_=b.fontWeight||"bold";this.fontStyle_=b.fontStyle||"normal";this.fontFamily_=b.fontFamily||"Arial,sans-serif";this.backgroundPosition_=b.backgroundPosition||"0 0"};ClusterIcon.prototype.setCenter=function(a){this.center_=a};ClusterIcon.prototype.createCss=function(b){var a=[];a.push("cursor: pointer;");a.push("position: absolute; top: "+b.y+"px; left: "+b.x+"px;");a.push("width: "+this.width_+"px; height: "+this.height_+"px;");return a.join("")};ClusterIcon.prototype.getPosFromLatLng_=function(a){var b=this.getProjection().fromLatLngToDivPixel(a);b.x-=this.anchorIcon_[1];b.y-=this.anchorIcon_[0];b.x=parseInt(b.x,10);b.y=parseInt(b.y,10);return b};function Cluster(a){this.markerClusterer_=a;this.map_=a.getMap();this.gridSize_=a.getGridSize();this.minClusterSize_=a.getMinimumClusterSize();this.averageCenter_=a.getAverageCenter();this.markers_=[];this.center_=null;this.bounds_=null;this.clusterIcon_=new ClusterIcon(this,a.getStyles())}Cluster.prototype.getSize=function(){return this.markers_.length};Cluster.prototype.getMarkers=function(){return this.markers_};Cluster.prototype.getCenter=function(){return this.center_};Cluster.prototype.getMap=function(){return this.map_};Cluster.prototype.getMarkerClusterer=function(){return this.markerClusterer_};Cluster.prototype.getBounds=function(){var a;var b=new google.maps.LatLngBounds(this.center_,this.center_);var c=this.getMarkers();for(a=0;a<c.length;a++){b.extend(c[a].getPosition())}return b};Cluster.prototype.remove=function(){this.clusterIcon_.setMap(null);this.markers_=[];delete this.markers_};Cluster.prototype.addMarker=function(a){var d;var c;var g;if(this.isMarkerAlreadyAdded_(a)){return false}if(!this.center_){this.center_=a.getPosition();this.calculateBounds_()}else{if(this.averageCenter_){var f=this.markers_.length+1;var b=(this.center_.lat()*(f-1)+a.getPosition().lat())/f;var e=(this.center_.lng()*(f-1)+a.getPosition().lng())/f;this.center_=new google.maps.LatLng(b,e);this.calculateBounds_()}}a.isAdded=true;this.markers_.push(a);c=this.markers_.length;g=this.markerClusterer_.getMaxZoom();if(g!==null&&this.map_.getZoom()>g){if(a.getMap()!==this.map_){a.setMap(this.map_)}}else{if(c<this.minClusterSize_){if(a.getMap()!==this.map_){a.setMap(this.map_)}}else{if(c===this.minClusterSize_){for(d=0;d<c;d++){this.markers_[d].setMap(null)}}else{a.setMap(null)}}}this.updateIcon_();return true};Cluster.prototype.isMarkerInClusterBounds=function(a){return this.bounds_.contains(a.getPosition())};Cluster.prototype.calculateBounds_=function(){var a=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=this.markerClusterer_.getExtendedBounds(a)};Cluster.prototype.updateIcon_=function(){var c=this.markers_.length;var a=this.markerClusterer_.getMaxZoom();if(a!==null&&this.map_.getZoom()>a){this.clusterIcon_.hide();return}if(c<this.minClusterSize_){this.clusterIcon_.hide();return}var b=this.markerClusterer_.getStyles().length;var d=this.markerClusterer_.getCalculator()(this.markers_,b);this.clusterIcon_.setCenter(this.center_);this.clusterIcon_.useStyle(d);this.clusterIcon_.show()};Cluster.prototype.isMarkerAlreadyAdded_=function(b){var a;if(this.markers_.indexOf){return this.markers_.indexOf(b)!==-1}else{for(a=0;a<this.markers_.length;a++){if(b===this.markers_[a]){return true}}}return false};function MarkerClusterer(a,c,b){this.extend(MarkerClusterer,google.maps.OverlayView);c=c||[];b=b||{};this.markers_=[];this.clusters_=[];this.listeners_=[];this.activeMap_=null;this.ready_=false;this.gridSize_=b.gridSize||60;this.minClusterSize_=b.minimumClusterSize||2;this.maxZoom_=b.maxZoom||null;this.styles_=b.styles||[];this.title_=b.title||"";this.zoomOnClick_=true;if(b.zoomOnClick!==undefined){this.zoomOnClick_=b.zoomOnClick}this.averageCenter_=false;if(b.averageCenter!==undefined){this.averageCenter_=b.averageCenter}this.ignoreHidden_=false;if(b.ignoreHidden!==undefined){this.ignoreHidden_=b.ignoreHidden}this.enableRetinaIcons_=false;if(b.enableRetinaIcons!==undefined){this.enableRetinaIcons_=b.enableRetinaIcons}this.imagePath_=b.imagePath||MarkerClusterer.IMAGE_PATH;this.imageExtension_=b.imageExtension||MarkerClusterer.IMAGE_EXTENSION;this.imageSizes_=b.imageSizes||MarkerClusterer.IMAGE_SIZES;this.calculator_=b.calculator||MarkerClusterer.CALCULATOR;this.batchSize_=b.batchSize||MarkerClusterer.BATCH_SIZE;this.batchSizeIE_=b.batchSizeIE||MarkerClusterer.BATCH_SIZE_IE;this.clusterClass_=b.clusterClass||"cluster";if(navigator.userAgent.toLowerCase().indexOf("msie")!==-1){this.batchSize_=this.batchSizeIE_}this.setupStyles_();this.addMarkers(c,true);this.setMap(a)}MarkerClusterer.prototype.onAdd=function(){var a=this;this.activeMap_=this.getMap();this.ready_=true;this.repaint();this.listeners_=[google.maps.event.addListener(this.getMap(),"zoom_changed",function(){a.resetViewport_(false);if(this.getZoom()===(this.get("minZoom")||0)||this.getZoom()===this.get("maxZoom")){google.maps.event.trigger(this,"idle")}}),google.maps.event.addListener(this.getMap(),"idle",function(){a.redraw_()})]};MarkerClusterer.prototype.onRemove=function(){var a;for(a=0;a<this.markers_.length;a++){if(this.markers_[a].getMap()!==this.activeMap_){this.markers_[a].setMap(this.activeMap_)}}for(a=0;a<this.clusters_.length;a++){this.clusters_[a].remove()}this.clusters_=[];for(a=0;a<this.listeners_.length;a++){google.maps.event.removeListener(this.listeners_[a])}this.listeners_=[];this.activeMap_=null;this.ready_=false};MarkerClusterer.prototype.draw=function(){};MarkerClusterer.prototype.setupStyles_=function(){var a,b;if(this.styles_.length>0){return}for(a=0;a<this.imageSizes_.length;a++){b=this.imageSizes_[a];this.styles_.push({url:this.imagePath_+(a+1)+"."+this.imageExtension_,height:b,width:b})}};MarkerClusterer.prototype.fitMapToMarkers=function(){var c;var b=this.getMarkers();var a=new google.maps.LatLngBounds();for(c=0;c<b.length;c++){a.extend(b[c].getPosition())}this.getMap().fitBounds(a)};MarkerClusterer.prototype.getGridSize=function(){return this.gridSize_};MarkerClusterer.prototype.setGridSize=function(a){this.gridSize_=a};MarkerClusterer.prototype.getMinimumClusterSize=function(){return this.minClusterSize_};MarkerClusterer.prototype.setMinimumClusterSize=function(a){this.minClusterSize_=a};MarkerClusterer.prototype.getMaxZoom=function(){return this.maxZoom_};MarkerClusterer.prototype.setMaxZoom=function(a){this.maxZoom_=a};MarkerClusterer.prototype.getStyles=function(){return this.styles_};MarkerClusterer.prototype.setStyles=function(a){this.styles_=a};MarkerClusterer.prototype.getTitle=function(){return this.title_};MarkerClusterer.prototype.setTitle=function(a){this.title_=a};MarkerClusterer.prototype.getZoomOnClick=function(){return this.zoomOnClick_};MarkerClusterer.prototype.setZoomOnClick=function(a){this.zoomOnClick_=a};MarkerClusterer.prototype.getAverageCenter=function(){return this.averageCenter_};MarkerClusterer.prototype.setAverageCenter=function(a){this.averageCenter_=a};MarkerClusterer.prototype.getIgnoreHidden=function(){return this.ignoreHidden_};MarkerClusterer.prototype.setIgnoreHidden=function(a){this.ignoreHidden_=a};MarkerClusterer.prototype.getEnableRetinaIcons=function(){return this.enableRetinaIcons_};MarkerClusterer.prototype.setEnableRetinaIcons=function(a){this.enableRetinaIcons_=a};MarkerClusterer.prototype.getImageExtension=function(){return this.imageExtension_};MarkerClusterer.prototype.setImageExtension=function(a){this.imageExtension_=a};MarkerClusterer.prototype.getImagePath=function(){return this.imagePath_};MarkerClusterer.prototype.setImagePath=function(a){this.imagePath_=a};MarkerClusterer.prototype.getImageSizes=function(){return this.imageSizes_};MarkerClusterer.prototype.setImageSizes=function(a){this.imageSizes_=a};MarkerClusterer.prototype.getCalculator=function(){return this.calculator_};MarkerClusterer.prototype.setCalculator=function(a){this.calculator_=a};MarkerClusterer.prototype.getBatchSizeIE=function(){return this.batchSizeIE_};MarkerClusterer.prototype.setBatchSizeIE=function(a){this.batchSizeIE_=a};MarkerClusterer.prototype.getClusterClass=function(){return this.clusterClass_};MarkerClusterer.prototype.setClusterClass=function(a){this.clusterClass_=a};MarkerClusterer.prototype.getMarkers=function(){return this.markers_};MarkerClusterer.prototype.getTotalMarkers=function(){return this.markers_.length};MarkerClusterer.prototype.getClusters=function(){return this.clusters_};MarkerClusterer.prototype.getTotalClusters=function(){return this.clusters_.length};MarkerClusterer.prototype.addMarker=function(b,a){this.pushMarkerTo_(b);if(!a){this.redraw_()}};MarkerClusterer.prototype.addMarkers=function(b,a){var c;for(c in b){if(b.hasOwnProperty(c)){this.pushMarkerTo_(b[c])}}if(!a){this.redraw_()}};MarkerClusterer.prototype.pushMarkerTo_=function(b){if(b.getDraggable()){var a=this;google.maps.event.addListener(b,"dragend",function(){if(a.ready_){this.isAdded=false;a.repaint()}})}b.isAdded=false;this.markers_.push(b)};MarkerClusterer.prototype.removeMarker=function(c,a){var b=this.removeMarker_(c);if(!a&&b){this.repaint()}return b};MarkerClusterer.prototype.removeMarkers=function(c,a){var d,e;var b=false;for(d=0;d<c.length;d++){e=this.removeMarker_(c[d]);b=b||e}if(!a&&b){this.repaint()}return b};MarkerClusterer.prototype.removeMarker_=function(b){var c;var a=-1;if(this.markers_.indexOf){a=this.markers_.indexOf(b)}else{for(c=0;c<this.markers_.length;c++){if(b===this.markers_[c]){a=c;break}}}if(a===-1){return false}b.setMap(null);this.markers_.splice(a,1);return true};MarkerClusterer.prototype.clearMarkers=function(){this.resetViewport_(true);this.markers_=[]};MarkerClusterer.prototype.repaint=function(){var a=this.clusters_.slice();this.clusters_=[];this.resetViewport_(false);this.redraw_();setTimeout(function(){var b;for(b=0;b<a.length;b++){a[b].remove()}},0)};MarkerClusterer.prototype.getExtendedBounds=function(b){var h=this.getProjection();var a=new google.maps.LatLng(b.getNorthEast().lat(),b.getNorthEast().lng());var f=new google.maps.LatLng(b.getSouthWest().lat(),b.getSouthWest().lng());var c=h.fromLatLngToDivPixel(a);c.x+=this.gridSize_;c.y-=this.gridSize_;var d=h.fromLatLngToDivPixel(f);d.x-=this.gridSize_;d.y+=this.gridSize_;var g=h.fromDivPixelToLatLng(c);var e=h.fromDivPixelToLatLng(d);b.extend(g);b.extend(e);return b};MarkerClusterer.prototype.redraw_=function(){this.createClusters_(0)};MarkerClusterer.prototype.resetViewport_=function(c){var b,a;for(b=0;b<this.clusters_.length;b++){this.clusters_[b].remove()}this.clusters_=[];for(b=0;b<this.markers_.length;b++){a=this.markers_[b];a.isAdded=false;if(c){a.setMap(null)}}};MarkerClusterer.prototype.distanceBetweenPoints_=function(j,g){var f=6371;var h=(g.lat()-j.lat())*Math.PI/180;var k=(g.lng()-j.lng())*Math.PI/180;var e=Math.sin(h/2)*Math.sin(h/2)+Math.cos(j.lat()*Math.PI/180)*Math.cos(g.lat()*Math.PI/180)*Math.sin(k/2)*Math.sin(k/2);var i=2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e));var b=f*i;return b};MarkerClusterer.prototype.isMarkerInBounds_=function(b,a){return a.contains(b.getPosition())};MarkerClusterer.prototype.addToClosestCluster_=function(b){var g,c,e,f;var h=40000;var a=null;for(g=0;g<this.clusters_.length;g++){e=this.clusters_[g];f=e.getCenter();if(f){c=this.distanceBetweenPoints_(f,b.getPosition());if(c<h){h=c;a=e}}}if(a&&a.isMarkerInClusterBounds(b)){a.addMarker(b)}else{e=new Cluster(this);e.addMarker(b);this.clusters_.push(e)}};MarkerClusterer.prototype.createClusters_=function(c){var e,b;var a;var f=this;if(!this.ready_){return}if(c===0){google.maps.event.trigger(this,"clusteringbegin",this);if(typeof this.timerRefStatic!=="undefined"){clearTimeout(this.timerRefStatic);delete this.timerRefStatic}}if(this.getMap().getZoom()>3){a=new google.maps.LatLngBounds(this.getMap().getBounds().getSouthWest(),this.getMap().getBounds().getNorthEast())}else{a=new google.maps.LatLngBounds(new google.maps.LatLng(85.0207077174347,-178.48388434375),new google.maps.LatLng(-85.0813644438454,178.00048865625))}var d=this.getExtendedBounds(a);var g=Math.min(c+this.batchSize_,this.markers_.length);for(e=c;e<g;e++){b=this.markers_[e];if(!b.isAdded&&this.isMarkerInBounds_(b,d)){if(!this.ignoreHidden_||(this.ignoreHidden_&&b.getVisible())){this.addToClosestCluster_(b)}}}if(g<this.markers_.length){this.timerRefStatic=setTimeout(function(){f.createClusters_(g)},0)}else{delete this.timerRefStatic;google.maps.event.trigger(this,"clusteringend",this)}};MarkerClusterer.prototype.extend=function(b,a){return(function(d){var c;for(c in d.prototype){this.prototype[c]=d.prototype[c]}return this}).apply(b,[a])};MarkerClusterer.CALCULATOR=function(c,a){var e=0;var d="";var b=c.length.toString();var f=b;while(f!==0){f=parseInt(f/10,10);e++}e=Math.min(e,a);return{text:b,index:e,title:d}};MarkerClusterer.BATCH_SIZE=2000;MarkerClusterer.BATCH_SIZE_IE=500;MarkerClusterer.IMAGE_PATH="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclustererplus/images/m";MarkerClusterer.IMAGE_EXTENSION="png";MarkerClusterer.IMAGE_SIZES=[53,56,66,78,90];